---
title: 自动化测试
description: 杭州宏杉学习笔记-自动化测试
#cover: /cover/cover2.png
tag:
- 杭州宏杉
- 自动化测试
- Java
  #sticky: 999
date: 2025-07-29 10:35
---

## 自动化测试环境

* jdk1.8[https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html]
* maven3.9.3[https://maven.apache.org/]

## 项目结构

```text
mcloud_test/Test
├── lib     // 项目本地依赖jar包
│   ├── acl-0.0.1.jar
│   ├ ...
├── pom.xml     // 项目 pom.xml
├── ssl     // ssl相关工具
│   ├── DefaultSSLVerifier.java     // 默认ssl验证
│   ├── Readme.md
│   ├── ZSClient.java       // zstack ssl客户端
│   └── ZSConfig.java       // zstack ssl配置
├── test        // 主测试模块
│   ├── pom.xml     // 测试模块pom.xml
│   ├── src
│   │   └── test
│   │       ├── java ...
│   │       │    └── test
│   │       │        ├── api    // MCloud服务api
│   │       │        │   ├── Api.java
│   │       │        │   ├─ ...
│   │       │        ├── constant       // 常量定义
│   │       │        │   ├── ResourceConstant.java
│   │       │        │   ├─ ...
│   │       │        ├── deployer       // 部署器？（环境配置）相关
│   │       │        │   ├── AbstractDeployer.java
│   │       │        │   ├─ ...*.java
│   │       │        │   ├── schema     // 部署器配置模型
│   │       │        │   │   ├── AccountConfig.java
│   │       │        │   │   ├─ ...
│   │       │        ├── factory        // 工厂类
│   │       │        │   ├── BackupStorageFactory.java
│   │       │        │   ├─ ...
│   │       │        ├── FT     // 容错(Fault Tolerance)测试
│   │       │        │   ├── FtTest.java        // 测试基类
│   │       │        │   ├── host       // 物理机容错测试
│   │       │        │   │   ├── TestAllHostAlternatePowerOff.java      // 物理机交替掉电测试
│   │       │        │   │   ├─ ...
│   │       │        │   ├── synchronized_netcard       // 同步网卡测试
│   │       │        │   │   ├── TestAllHostAlternateDownABNetcard.java     // 物理机网卡交替关闭测试
│   │       │        │   │   ├─ ...
│   │       │        │   ├── Test1.java     // 测试用例前置，用于加载deployerXML配置文件
│   │       │        │   ├── TestSuite.java     // 测试用例套件
│   │       │        ├── HA     // 高可用(High Availability)相关测试
│   │       │        │   ├── HaTest.java        // 高可用测试基类
│   │       │        │   ├── host       // 物理机相关测试
│   │       │        │   │   ├── TestAllHostAlternatePowerOffOn.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── l2_netcard // L2网卡相关测试
│   │       │        │   │   ├── TestAllHostDownNetCard.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── Test1.java
│   │       │        │   └── TestSuite.java
│   │       │        ├── imageshare_mcloud      // 不同存储之间迁移云盘？
│   │       │        │   ├── image
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   └── vm
│   │       │        │       ├── LocalToMStor.java
│   │       │        │       ├─ ...
│   │       │        ├── local_mcloud       // Local存储的MCloud测试
│   │       │        │   ├── clonevm        // 克隆VM
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── image      // 系统镜像相关测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── instanceoffering       // 计算规格相关测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── isovm      // 云主机iso相关测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── migratevm      // 云主机迁移测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── vm     // 云主机相关测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── vmsnap     // 云主机快照相关测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── volume     // 云盘相关测试
│   │       │        │   │   ├── Test1.java
│   │       │        │   │   ├─ ...
│   │       │        │   └── volumesnap // 云盘快照相关测试
│   │       │        │       ├── Test1.java
│   │       │        │       ├─ ...
│   │       │        ├── macrosan_mcloud_sdas       // 双活存储相关测试
│   │       │        │   ├── clonevm
│   │       │        │   ├── isovm
│   │       │        │   ├── migratevm
│   │       │        │   ├── repvm
│   │       │        │   ├── vm
│   │       │        │   ├── vmsnap
│   │       │        │   └── volume
│   │       │        ├── mdbs_mcloud        // MDBS相关测试
│   │       │        ├── psMigrate      // 迁移功能测试（更改物理机，更改主存储，更改物理机和主存储）
│   │       │        ├── sharedBlock_mcloud     // sharedBlock存储相关测试
│   │       │        ├── upgrade        // 升级测试
│   │       │        │   ├── before
│   │       │        │   │   ├── TestAttachVirtioDataVolumeWithRunningVm.java
│   │       │        │   │   ├─ ...
│   │       │        │   ├── Test1.java
│   │       │        │   ├─ ...
│   │       │        ├── util       // 工具类
│   │       │        │   ├── CommandUtil.java
│   │       │        │   ├─ ...
│   │       │        ├── BaseTest.java  // 测试基类
│   │       │        ├── CaseExceptionInterceptor.java      // 测试异常拦截器
│   │       │        ├── TestDeployer.java      // 以下5个文件未被使用
│   │       │        ├── package-info.java     
│   │       │        ├── TestScriptRunner.java
│   │       │        ├── UnitTestSuiteConfig.java
│   │       │        └── UnitTestSuite.java
│   │       └── resources
│   │           ├── caseRunShell        // 测试用例执行脚本，带base的为开发使用，用例数量较少
│   │           │   ├── case_run_base.sh
│   │           │   ├── case_run_ft.sh
│   │           │   ├── case_run_ha.sh
│   │           │   ├── case_run_image_share.sh
│   │           │   ├── case_run_migrate.sh
│   │           │   ├── case_run_nfs_base.sh
│   │           │   ├── case_run_nfs.sh
│   │           │   ├── case_run_san_sdas.sh
│   │           │   ├── case_run_sblk_base.sh
│   │           │   ├── case_run_sblk.sh
│   │           │   ├── case_run_sftp_base.sh
│   │           │   ├── case_run_sftp.sh
│   │           │   ├── case_run.sh
│   │           │   └── case_run_upgrade.sh
│   │           ├── deployerXml     // 测试用例配置文件
│   │           │   ├── ft
│   │           │   │   └── ft.xml
│   │           │   ├─ ...
│   │           ├── env     // 测试环境配置文件
│   │           ├── junit-platform.properties
│   │           ├── log4j2.xml
│   │           ├── mcloud.properties   // MCloud相关配置文件
│   │           ├── META-INF
│   │           │   ├── metafile.properties
│   │           │   └── services
│   │           │       └── org.junit.jupiter.api.extension.Extension
│   │           ├── psMigrateCrossPool.csv
│   │           ├── psMigrate.csv
│   │           ├── UnitTestSuiteConfig.xml
│   │           ├── unitTestSuiteXml
│   │           │   ├── AccountManager.xml
│   │           │   └── Vm.xml
│   │           ├── virsh_login         // 云主机功能相关脚本
│   │           │   ├── attach_guest_tools.sh
│   │           │   ├─ ...
│   │           └── xsd
│   │               ├── deployer
│   │               │   ├── compute.xsd
│   │               │   ├─ ...
│   │               └── UnitTestSuite.xsd

```

## 使用说明

* 根据需要自动化测试的环境，对照文档《自动化教程》代码分类表格，确定执行的脚本和需要修改的代码。（如测试local主存储的脚本为case_run_sftp_base.sh，需要修改env文件和deployerXml/nfs_mcloud/nfs_mcloud.xml文件）
* env文件保存的为环境配置，例如管理节点IP，物理节点ip，bmcip，主存储类型，二层网络网卡名等
* deployerXml文件夹下的xml文件为环境中的资源配置，例如创建的计算规格参数，云盘规格参数，区域，集群和物理机，二三层网络配置，上传的镜像资源等

## 用例说明

**以local主存储为例**

### 镜像相关（image）

**_共计8个用例_**

#### 用例套件资源初始化（Test1）
* 1.删除所有资源缓存（资源通过api查询到后会缓存在本地的HashMap中），若env环境配置文件中`deleteAllResource`为`true`(默认为false），则会删除云平台上的所有测试资源
  ```java
  ResourceUtil.deleteAllResource(api);
  ```
* 2.加载`deployerXml`配置文件,并初始化deployerXml中的测试资源（创建计算规格参数，云盘规格参数，区域，集群和物理机，二三层网络配置，上传的镜像资源等）
  ```java
  Deployer deployer = new Deployer("deployerXml/nfs_mcloud/nfs_mcloud.xml");
  deployer.build();
  ```
* 3.通过获取主存储类型验证资源是否初始化成功，资源不存在则api会抛异常
  ```java
  @Test
    public void test() throws InterruptedException, ApiSenderException, IOException {
        ResourceUtil.getPrimaryStorageFromType(TypeConstant.NFS_PRIMARY_STORAGE_TYPE);
    }
  ```

#### 创建两个RAW格式镜像：TinyLinux-1、TinyLinux-2（TestCreateRAWImage）

* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
  ```java
  @BeforeEach
  public void setUp() throws Exception {
      logger.debug("\n\n---------- {} is running now ----------\n", this.getClass().getName());
      api.prepare();
      api.deleteVmAndVolume();
  }
  ```
* 2.获取主存储和镜像服务器的信息
  ```java
  PrimaryStorageInventory primaryStorage = ResourceUtil.getPrimaryStorageFromEnv();

  BackupStorageInventory backupStorage = getBackupStorageFromType(ResourceConstant.SFTP_STORAGE_NAME);
  ```
* 3.获取镜像1和镜像2的信息,通过断言判断镜像状态是否为`Ready`和`Enabled`
  ```java
  ImageInventory image1Info = ResourceUtil.getImage(ResourceConstant.TEST_IMAGE_NAME + "-1");
  String img1Uuid = image1Info.getUuid();
  assertEquals("Ready", image1Info.getStatus());
  assertEquals("Enabled", image1Info.getState());
  
  ImageInventory image2Info = ResourceUtil.getImage(ResourceConstant.TEST_IMAGE_NAME + "-2");
  String img2Uuid = image2Info.getUuid();
  assertEquals("Ready", image2Info.getStatus());
  assertEquals("Enabled", image2Info.getState());
  ```

* 4.等待30s，防止初始化资源后未更新数据
* 5.调用`sync`api重新查询镜像信息，通过断言镜像大小不为0判断镜像是否创建成功
  ```java
  image1Info = api.syncImageSize(img1Uuid);
  image2Info = api.syncImageSize(img2Uuid);

  assertNotEquals(0, image1Info.getActualSize());
  assertNotEquals(0, image2Info.getActualSize());
  ```

#### 使用云盘根盘创建镜像，使用该云盘镜像创建云主机（TestCreatVmFromRootVolumeTemplate）

* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取各资源实例（集群，三层网络，云盘规格，计算规格，镜像服务器，主存储,镜像）
  ```java
  ClusterInventory cluster = getCluster();
  L3NetworkInventory l3Network = api.queryL3Network("name", "TestL3Network1");
  DiskOfferingInventory rootDiskOffering = api.queryDiskOffering("name", "TestRootDiskOffering");
  InstanceOfferingInventory instanceOffering = api.queryInstanceOffering("name", "TestInstanceOffering1");
  HostInventory host1 = ResourceUtil.queryHost1();
  ImageInventory image = api.queryImage("name", "TinyLinux-1");

  PrimaryStorageInventory primaryStorage = ResourceUtil.getPrimaryStorageFromEnv();

  BackupStorageInventory backupStorage = getBackupStorageFromType(ResourceConstant.SFTP_STORAGE_NAME);
  ```
* 3.使用上述资源创建一台云主机TestCase-vm1
  ```java
  VmInstanceInventory vmInstance1 = api.createVmInstance("vm1", instanceOffering.getUuid(), image.getUuid(),
    l3Network.getUuid(), rootDiskOffering.getUuid(), cluster.getUuid(), "this is a vm",
    "InstantStart", null);
  ```
* 4.使用创建的云主机的根盘创建云盘规格TestRootDiskOffering
  ```java
  ImageInventory rootVolumeTemplate = api.createRootVolumeTemplateFromRootVolume("My Root Volume Template",
    vmInstance1.getRootVolumeUuid(), asList(backupStorage.getUuid()), "Linux", false);
  String rootVolumeTemplateUuid = rootVolumeTemplate.getUuid();
  ```
* 5.使用该云盘规格创建一台云主机TestCase-vm2
  ```java
  VmInstanceInventory vmInstance2 = api.createVmInstance("vm2", instanceOffering.getUuid(), rootVolumeTemplateUuid,
    l3Network.getUuid(), cluster.getUuid(), "InstantStart");
  ```
* 6.通过云主机UUID查询云主机状态，断言判断状态是否为运行中
  ```java
  vmInstance2 = api.queryVm("uuid", vmInstance2.getUuid());
  assertEquals(VmInstanceState.Running.toString(), vmInstance2.getState());
  ```
* 7.重启云主机，再次断言判断状态是否为运行中
  ```java
  api.rebootVmInstance(vmInstance2.getUuid());
  vmInstance2 = api.queryVm("name", "vm2");
  assertEquals(VmInstanceState.Running.toString(), vmInstance2.getState());
  ```

#### 测试单个镜像的删除与恢复

* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取所需资源实例（集群，三层网络，计算规格，镜像服务器，主存储,镜像-TinyLinux-1）
* 3.使用上述镜像创建一台云主机TestCase-vm1,并断言确保创建成功
* 4.从镜像服务器中删除该镜像
  ```java
  List<String> backupList = Collections.singletonList(backupStorage.getUuid());

  api.deleteImage(imgUuid, backupList);
  image = api.queryImage("uuid", imgUuid);
  logger.debug(image.getState());
  ```
* 5.恢复镜像
  ```java
  api.recoverImage(imgUuid, backupList);
  ```
* 6.再次使用该镜像创建云主机TestCase-vm2，并断言确保创建成功
* 7.两台云主机关机后再开机，并断言确保状态正常
  ```java
  api.stopVmInstance(vmInstance1.getUuid());
  api.stopVmInstance(vmInstance2.getUuid());  
  VmInstanceInventory vm11 = api.queryVm("name", "vm1");
  assertEquals(VmInstanceState.Stopped.toString(), vm11.getState());  
  VmInstanceInventory vm22 = api.queryVm("name", "vm2");
  assertEquals(VmInstanceState.Stopped.toString(), vm22.getState());  
  api.startVmInstance(vmInstance1.getUuid());
  api.startVmInstance(vmInstance2.getUuid()); 
  vmInstance1 = api.queryVm("name", "vm1");
  assertEquals(VmInstanceState.Running.toString(), vmInstance1.getState()); 
  vmInstance2 = api.queryVm("name", "vm2");
  assertEquals(VmInstanceState.Running.toString(), vmInstance2.getState());
  ```
  
#### 测试删除多个镜像后恢复

* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取所需资源实例（集群，三层网络，计算规格，镜像服务器，主存储,镜像-TinyLinux-1/2/3）
* 3.使用镜像TinyLinux-2/3分别创建两台云主机vm1和vm2，并执行重启操作，断言确保状态正常
* 4.删除3个镜像，并使用断言确保镜像状态为已删除`Deleted`
  ```java
  api.deleteImage(img1Uuid, backupList);
  api.deleteImage(img2Uuid, backupList);
  api.deleteImage(img3Uuid, backupList);

  image1 = api.queryImage("uuid", img1Uuid);
  logger.debug("image1 state : {}", image1.getState());
  logger.debug("image1 status : {}", image1.getStatus());
  assertEquals("Deleted", image1.getStatus());

  image2 = api.queryImage("uuid", img2Uuid);
  logger.debug("image2 state : {}", image2.getState());
  logger.debug("image2 status : {}", image2.getStatus());
  assertEquals("Deleted", image2.getStatus());

  image3 = api.queryImage("uuid", img3Uuid);
  logger.debug("image3 state : {}", image3.getState());
  logger.debug("image3 status : {}", image3.getStatus());
  assertEquals("Deleted", image3.getStatus());
  ```
* 5.恢复3个镜像，并断言确保镜像状态为`Ready`

#### 测试更新镜像名称和描述
* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取所需资源实例（集群，三层网络，计算规格，镜像服务器，主存储,镜像-TinyLinux-1）
* 3.使用上述镜像创建一台云主机TestCase-vm1,并断言确保创建成功
* 4.重命名镜像名为`Image-new`，描述为`new description`，断言更新后的名称和描述
  ```java
  image = api.updateImage(imgUuid, "Image-new", "Linux", "new description");
  imgUuid = image.getUuid();
  logger.debug("------------Update image---------------");
  logger.debug("image uuid : {}", imgUuid);
  logger.debug("image name : {}", image.getName());
  assertEquals("Image-new", image.getName());
  logger.debug("image description : {}", image.getDescription());
  assertEquals("new description", image.getDescription());
  ```
* 5.使用更新后的镜像创建一个云主机vm2，并断言确保创建成功，再重启，断言确保状态正确
* 6.将镜像名称改回`TinyLinux-1`，并断言确保修改成功

#### 测试停用和启用多个镜像
* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取所需资源实例（集群，三层网络，计算规格，镜像服务器，主存储,镜像-TinyLinux-1/2）
* 3.使用镜像TinyLinux-1/2分别创建两台云主机vm1和vm2，断言确保状态正常
* 4.停用2个镜像
  ```java
  api.changeImageState(img1Uuid, ImageStateEvent.disable);
  api.changeImageState(img2Uuid, ImageStateEvent.disable);
  TimeUnit.SECONDS.sleep(5);
  ```
* 5.使用`TinyLinux-1`创建云主机vm3，并断言确保创建报错
  ```java
  boolean hasException = false;
  try {
      api.createVmInstance("vm3", instanceOffering.getUuid(), img1Uuid, l3Network.getUuid(),
              cluster.getUuid(), "InstantStart");
  } catch (Exception e) {
      hasException = true;
  }
  assertTrue(hasException);
  ```
* 6.启用2个镜像
  ```java
  api.changeImageState(img1Uuid, ImageStateEvent.enable);
  api.changeImageState(img2Uuid, ImageStateEvent.enable);
  ```
* 7.使用两个镜像分别创建vm3和vm4，并断言确保没有报错
  ```java
  hasException = false;
  try {
      api.createVmInstance("vm3", instanceOffering.getUuid(), img1Uuid, l3Network.getUuid(),
              cluster.getUuid(), "InstantStart");
  } catch (Exception e) {
      hasException = true;
  }
  assertFalse(hasException);
  try {
      api.createVmInstance("vm4", instanceOffering.getUuid(), img2Uuid, l3Network.getUuid(),
              cluster.getUuid(), "InstantStart");
  } catch (Exception e) {
      hasException = true;
  }
  assertFalse(hasException);
  ```
* 8.查询并断言两个vm的运行状态，重启两台vm后再次断言确保状态正常

#### 测试停用和启用单个镜像
* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取所需资源实例（集群，三层网络，计算规格，镜像服务器，主存储,镜像-TinyLinux-1）
* 3.使用镜像TinyLinux-1创建云主机vm1，断言确保状态正常
* 4.停用镜像
* 5.使用`TinyLinux-1`创建云主机vm3，并断言确保创建报错
* 6.启用镜像
* 7.再次使用镜像创建vm3，并断言确保没有报错
* 8.查询并断言vm的运行状态，重启vm后再次断言确保状态正常

#### 测试彻底删除镜像
* 1.`setUp`准备api（获取admin账户session），删除所有测试云主机及绑定的数据盘
* 2.获取所需资源实例（集群，三层网络，计算规格，镜像服务器，主存储,镜像-TinyLinux-3）
* 3.使用上述镜像创建一台云主机vm1，并断言确保创建成功
* 4.将镜像彻底删除
  ```java
  api.deleteImage(imgUuid, backupList);
  image = api.queryImage("uuid", imgUuid);
  logger.debug("image state : {}", image.getState());
  //彻底删除
  api.expungeImage(imgUuid, backupList);
  ```
* 5.查询镜像信息，断言确保镜像数据为`Null`
  ```java
  image = api.queryImage("uuid", imgUuid);
  assertNull(image);
  logger.debug("---------------------------");
  logger.debug("image has been expunged");
  ```